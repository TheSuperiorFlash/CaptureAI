{
  "version": 3,
  "sources": ["../bundle-acU3Du/checked-fetch.js", "../../../src/utils.js", "../../../src/validation.js", "../../../src/logger.js", "../../../src/auth.js", "../../../src/ai.js", "../../../src/subscription.js", "../../../src/router.js", "../../../src/index.js", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-acU3Du/middleware-insertion-facade.js", "../../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts", "../bundle-acU3Du/middleware-loader.entry.ts"],
  "sourceRoot": "C:\\Users\\SuperiorFlash\\IdeaProjects\\CaptureAI\\backend\\.wrangler\\tmp\\dev-a3gFYO",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "/**\n * Utility functions\n */\n\n/**\n * Create JSON response\n */\nexport function jsonResponse(data, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: {\n      'Content-Type': 'application/json'\n    }\n  });\n}\n\n/**\n * Handle CORS preflight\n */\nexport function handleCORS(request) {\n  // List of allowed origins\n  const allowedOrigins = [\n    'https://thesuperiorflash.github.io',\n  ];\n\n  // Development/testing origins (only if in dev mode)\n  const isDev = typeof globalThis !== 'undefined' && globalThis.env?.ENVIRONMENT === 'development';\n  if (isDev) {\n    allowedOrigins.push('http://localhost:3000', 'http://localhost:8080', 'http://127.0.0.1:3000');\n  }\n\n  // Get origin from request\n  const origin = request?.headers?.get('Origin') || '';\n\n  // Check if origin is allowed\n  let allowedOrigin = 'null';\n  if (origin) {\n    // Exact match for standard origins\n    if (allowedOrigins.includes(origin)) {\n      allowedOrigin = origin;\n    }\n    // Chrome extension support (all extensions allowed)\n    else if (origin.startsWith('chrome-extension://')) {\n      allowedOrigin = origin;\n    }\n    // Match GitHub Pages subdomain\n    else if (origin.match(/^https:\\/\\/.*\\.github\\.io$/)) {\n      allowedOrigin = origin;\n    }\n  }\n\n  return new Response(null, {\n    headers: {\n      'Access-Control-Allow-Origin': allowedOrigin,\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n      'Access-Control-Max-Age': '86400',\n      'Access-Control-Allow-Credentials': 'true',\n    }\n  });\n}\n\n/**\n * Parse JSON body safely with validation\n * @deprecated Use validateRequestBody from validation.js instead\n */\nexport async function parseJSON(request) {\n  try {\n    return await request.json();\n  } catch (error) {\n    throw new Error('Invalid JSON body');\n  }\n}\n\n/**\n * Hash password using Web Crypto API\n * Note: Workers don't have bcrypt, so we use PBKDF2\n */\nexport async function hashPassword(password) {\n  const encoder = new TextEncoder();\n  const data = encoder.encode(password);\n\n  // Generate salt\n  const salt = crypto.getRandomValues(new Uint8Array(16));\n\n  // Import key\n  const key = await crypto.subtle.importKey(\n    'raw',\n    data,\n    { name: 'PBKDF2' },\n    false,\n    ['deriveBits']\n  );\n\n  // Derive bits (hash)\n  const hashBuffer = await crypto.subtle.deriveBits(\n    {\n      name: 'PBKDF2',\n      salt: salt,\n      iterations: 100000,\n      hash: 'SHA-256'\n    },\n    key,\n    256\n  );\n\n  // Combine salt + hash\n  const hashArray = new Uint8Array(hashBuffer);\n  const combined = new Uint8Array(salt.length + hashArray.length);\n  combined.set(salt);\n  combined.set(hashArray, salt.length);\n\n  // Return base64\n  return btoa(String.fromCharCode(...combined));\n}\n\n/**\n * Verify password against hash\n */\nexport async function verifyPassword(password, hash) {\n  try {\n    // Decode hash\n    const combined = Uint8Array.from(atob(hash), c => c.charCodeAt(0));\n    const salt = combined.slice(0, 16);\n    const originalHash = combined.slice(16);\n\n    // Hash password with same salt\n    const encoder = new TextEncoder();\n    const data = encoder.encode(password);\n\n    const key = await crypto.subtle.importKey(\n      'raw',\n      data,\n      { name: 'PBKDF2' },\n      false,\n      ['deriveBits']\n    );\n\n    const hashBuffer = await crypto.subtle.deriveBits(\n      {\n        name: 'PBKDF2',\n        salt: salt,\n        iterations: 100000,\n        hash: 'SHA-256'\n      },\n      key,\n      256\n    );\n\n    const newHash = new Uint8Array(hashBuffer);\n\n    // Compare\n    if (originalHash.length !== newHash.length) return false;\n\n    for (let i = 0; i < originalHash.length; i++) {\n      if (originalHash[i] !== newHash[i]) return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error('Password verification error:', error);\n    return false;\n  }\n}\n\n/**\n * Create JWT token using Web Crypto API\n */\nexport async function createJWT(payload, secret) {\n  const header = {\n    alg: 'HS256',\n    typ: 'JWT'\n  };\n\n  const encodedHeader = base64UrlEncode(JSON.stringify(header));\n  const encodedPayload = base64UrlEncode(JSON.stringify(payload));\n\n  const message = `${encodedHeader}.${encodedPayload}`;\n  const signature = await sign(message, secret);\n\n  return `${message}.${signature}`;\n}\n\n/**\n * Verify JWT token\n */\nexport async function verifyJWT(token, secret) {\n  try {\n    const parts = token.split('.');\n    if (parts.length !== 3) throw new Error('Invalid token format');\n\n    const [encodedHeader, encodedPayload, signature] = parts;\n    const message = `${encodedHeader}.${encodedPayload}`;\n\n    // Verify signature\n    const expectedSignature = await sign(message, secret);\n    if (signature !== expectedSignature) {\n      throw new Error('Invalid signature');\n    }\n\n    // Decode payload\n    const payload = JSON.parse(base64UrlDecode(encodedPayload));\n\n    // Check expiration\n    if (payload.exp && payload.exp < Date.now() / 1000) {\n      throw new Error('Token expired');\n    }\n\n    return payload;\n  } catch (error) {\n    throw new Error('Invalid token: ' + error.message);\n  }\n}\n\n/**\n * Sign message with HMAC-SHA256\n */\nasync function sign(message, secret) {\n  const encoder = new TextEncoder();\n  const key = await crypto.subtle.importKey(\n    'raw',\n    encoder.encode(secret),\n    { name: 'HMAC', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n\n  const signature = await crypto.subtle.sign(\n    'HMAC',\n    key,\n    encoder.encode(message)\n  );\n\n  return base64UrlEncode(signature);\n}\n\n/**\n * Base64 URL encode\n */\nfunction base64UrlEncode(data) {\n  let base64;\n\n  if (typeof data === 'string') {\n    base64 = btoa(data);\n  } else {\n    // ArrayBuffer\n    base64 = btoa(String.fromCharCode(...new Uint8Array(data)));\n  }\n\n  return base64\n    .replace(/\\+/g, '-')\n    .replace(/\\//g, '_')\n    .replace(/=/g, '');\n}\n\n/**\n * Base64 URL decode\n */\nfunction base64UrlDecode(str) {\n  str = str.replace(/-/g, '+').replace(/_/g, '/');\n  while (str.length % 4) {\n    str += '=';\n  }\n  return atob(str);\n}\n\n/**\n * Generate random UUID\n */\nexport function generateUUID() {\n  return crypto.randomUUID();\n}\n\n/**\n * Validate email format\n */\nexport function isValidEmail(email) {\n  const regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return regex.test(email);\n}\n\n/**\n * Constant-time string comparison to prevent timing attacks\n */\nexport function constantTimeCompare(a, b) {\n  if (typeof a !== 'string' || typeof b !== 'string') {\n    return false;\n  }\n\n  if (a.length !== b.length) {\n    return false;\n  }\n\n  let result = 0;\n  for (let i = 0; i < a.length; i++) {\n    result |= a.charCodeAt(i) ^ b.charCodeAt(i);\n  }\n\n  return result === 0;\n}\n", "/**\n * Input Validation Utilities\n * Comprehensive validation for all API inputs\n */\n\n/**\n * Validation error class\n */\nexport class ValidationError extends Error {\n  constructor(message, field = null) {\n    super(message);\n    this.name = 'ValidationError';\n    this.field = field;\n  }\n}\n\n/**\n * Maximum request body size (1MB)\n */\nconst MAX_BODY_SIZE = 1024 * 1024;\n\n/**\n * Validate and parse request body with size limit\n */\nexport async function validateRequestBody(request, maxSize = MAX_BODY_SIZE) {\n  try {\n    // Check content length header\n    const contentLength = request.headers.get('Content-Length');\n    if (contentLength && parseInt(contentLength) > maxSize) {\n      throw new ValidationError(`Request body too large. Maximum size: ${maxSize} bytes`);\n    }\n\n    // Read body with size check\n    const text = await request.text();\n    if (text.length > maxSize) {\n      throw new ValidationError(`Request body too large. Maximum size: ${maxSize} bytes`);\n    }\n\n    // Parse JSON\n    if (!text || text.trim() === '') {\n      return {};\n    }\n\n    try {\n      return JSON.parse(text);\n    } catch (error) {\n      throw new ValidationError('Invalid JSON format');\n    }\n  } catch (error) {\n    if (error instanceof ValidationError) throw error;\n    throw new ValidationError('Failed to parse request body');\n  }\n}\n\n/**\n * Validate email format (RFC 5322 simplified)\n */\nexport function validateEmail(email, required = true) {\n  if (!email || email.trim() === '') {\n    if (required) {\n      throw new ValidationError('Email is required', 'email');\n    }\n    return null;\n  }\n\n  // Type check\n  if (typeof email !== 'string') {\n    throw new ValidationError('Email must be a string', 'email');\n  }\n\n  // Trim whitespace\n  email = email.trim();\n\n  // Length check\n  if (email.length > 320) {\n    throw new ValidationError('Email is too long (max 320 characters)', 'email');\n  }\n\n  // Format validation (RFC 5322 simplified pattern)\n  const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n\n  if (!emailRegex.test(email)) {\n    throw new ValidationError('Invalid email format', 'email');\n  }\n\n  // Additional checks\n  const [localPart, domain] = email.split('@');\n\n  if (localPart.length > 64) {\n    throw new ValidationError('Email local part is too long (max 64 characters)', 'email');\n  }\n\n  if (domain.length > 255) {\n    throw new ValidationError('Email domain is too long (max 255 characters)', 'email');\n  }\n\n  // Check for common disposable email domains (optional - can be expanded)\n  const disposableDomains = ['tempmail.com', 'throwaway.email', 'guerrillamail.com'];\n  if (disposableDomains.some(d => domain.toLowerCase().endsWith(d))) {\n    throw new ValidationError('Disposable email addresses are not allowed', 'email');\n  }\n\n  return email.toLowerCase();\n}\n\n/**\n * Validate license key format\n */\nexport function validateLicenseKey(licenseKey, required = true) {\n  if (!licenseKey || licenseKey.trim() === '') {\n    if (required) {\n      throw new ValidationError('License key is required', 'licenseKey');\n    }\n    return null;\n  }\n\n  // Type check\n  if (typeof licenseKey !== 'string') {\n    throw new ValidationError('License key must be a string', 'licenseKey');\n  }\n\n  // Normalize (remove spaces, uppercase)\n  const normalized = licenseKey.replace(/\\s+/g, '').toUpperCase();\n\n  // Length check\n  if (normalized.length > 100) {\n    throw new ValidationError('License key is too long', 'licenseKey');\n  }\n\n  // Format check: XXXX-XXXX-XXXX-XXXX-XXXX (5 segments of 4 characters)\n  const licenseKeyRegex = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;\n\n  if (!licenseKeyRegex.test(normalized)) {\n    throw new ValidationError('Invalid license key format. Expected format: XXXX-XXXX-XXXX-XXXX-XXXX', 'licenseKey');\n  }\n\n  return normalized;\n}\n\n/**\n * Validate string field with length constraints\n */\nexport function validateString(value, fieldName, options = {}) {\n  const {\n    required = true,\n    minLength = 0,\n    maxLength = 1000,\n    pattern = null,\n    allowEmpty = false\n  } = options;\n\n  if (value === null || value === undefined || value === '') {\n    if (required && !allowEmpty) {\n      throw new ValidationError(`${fieldName} is required`, fieldName);\n    }\n    return allowEmpty ? '' : null;\n  }\n\n  // Type check\n  if (typeof value !== 'string') {\n    throw new ValidationError(`${fieldName} must be a string`, fieldName);\n  }\n\n  // Length checks\n  if (value.length < minLength) {\n    throw new ValidationError(`${fieldName} must be at least ${minLength} characters`, fieldName);\n  }\n\n  if (value.length > maxLength) {\n    throw new ValidationError(`${fieldName} must be at most ${maxLength} characters`, fieldName);\n  }\n\n  // Pattern check\n  if (pattern && !pattern.test(value)) {\n    throw new ValidationError(`${fieldName} has invalid format`, fieldName);\n  }\n\n  return value;\n}\n\n/**\n * Validate number field with range constraints\n */\nexport function validateNumber(value, fieldName, options = {}) {\n  const {\n    required = true,\n    min = -Infinity,\n    max = Infinity,\n    integer = false\n  } = options;\n\n  if (value === null || value === undefined) {\n    if (required) {\n      throw new ValidationError(`${fieldName} is required`, fieldName);\n    }\n    return null;\n  }\n\n  // Type coercion and check\n  const num = Number(value);\n  if (isNaN(num)) {\n    throw new ValidationError(`${fieldName} must be a number`, fieldName);\n  }\n\n  // Integer check\n  if (integer && !Number.isInteger(num)) {\n    throw new ValidationError(`${fieldName} must be an integer`, fieldName);\n  }\n\n  // Range checks\n  if (num < min) {\n    throw new ValidationError(`${fieldName} must be at least ${min}`, fieldName);\n  }\n\n  if (num > max) {\n    throw new ValidationError(`${fieldName} must be at most ${max}`, fieldName);\n  }\n\n  return num;\n}\n\n/**\n * Validate enum field (must be one of allowed values)\n */\nexport function validateEnum(value, fieldName, allowedValues, required = true) {\n  if (value === null || value === undefined || value === '') {\n    if (required) {\n      throw new ValidationError(`${fieldName} is required`, fieldName);\n    }\n    return null;\n  }\n\n  if (!allowedValues.includes(value)) {\n    throw new ValidationError(\n      `${fieldName} must be one of: ${allowedValues.join(', ')}`,\n      fieldName\n    );\n  }\n\n  return value;\n}\n\n/**\n * Validate array field\n */\nexport function validateArray(value, fieldName, options = {}) {\n  const {\n    required = true,\n    minLength = 0,\n    maxLength = 100,\n    itemValidator = null\n  } = options;\n\n  if (value === null || value === undefined) {\n    if (required) {\n      throw new ValidationError(`${fieldName} is required`, fieldName);\n    }\n    return null;\n  }\n\n  // Type check\n  if (!Array.isArray(value)) {\n    throw new ValidationError(`${fieldName} must be an array`, fieldName);\n  }\n\n  // Length checks\n  if (value.length < minLength) {\n    throw new ValidationError(`${fieldName} must have at least ${minLength} items`, fieldName);\n  }\n\n  if (value.length > maxLength) {\n    throw new ValidationError(`${fieldName} must have at most ${maxLength} items`, fieldName);\n  }\n\n  // Item validation\n  if (itemValidator) {\n    return value.map((item, index) => {\n      try {\n        return itemValidator(item);\n      } catch (error) {\n        throw new ValidationError(`${fieldName}[${index}]: ${error.message}`, fieldName);\n      }\n    });\n  }\n\n  return value;\n}\n\n/**\n * Validate AI prompt input\n */\nexport function validatePrompt(prompt, fieldName = 'prompt') {\n  return validateString(prompt, fieldName, {\n    required: true,\n    minLength: 1,\n    maxLength: 50000, // 50KB max prompt\n    allowEmpty: false\n  });\n}\n\n/**\n * Validate AI model name\n */\nexport function validateModel(model) {\n  const allowedModels = ['gpt-4.1-nano', 'gpt-5-nano'];\n  return validateEnum(model, 'model', allowedModels, false);\n}\n\n/**\n * Validate reasoning level\n */\nexport function validateReasoningLevel(level) {\n  if (level === null || level === undefined) {\n    return null;\n  }\n\n  const num = validateNumber(level, 'reasoningLevel', {\n    required: false,\n    min: 0,\n    max: 2,\n    integer: true\n  });\n\n  return num;\n}\n\n/**\n * Sanitize string to prevent XSS and injection attacks\n */\nexport function sanitizeString(str) {\n  if (typeof str !== 'string') return str;\n\n  // Remove null bytes\n  str = str.replace(/\\0/g, '');\n\n  // Trim whitespace\n  str = str.trim();\n\n  return str;\n}\n\n/**\n * Validate and sanitize all fields in an object\n */\nexport function sanitizeObject(obj) {\n  if (typeof obj !== 'object' || obj === null) return obj;\n\n  const sanitized = {};\n  for (const [key, value] of Object.entries(obj)) {\n    if (typeof value === 'string') {\n      sanitized[key] = sanitizeString(value);\n    } else if (typeof value === 'object' && value !== null) {\n      sanitized[key] = sanitizeObject(value);\n    } else {\n      sanitized[key] = value;\n    }\n  }\n\n  return sanitized;\n}\n\n/**\n * Validate Stripe webhook signature header\n */\nexport function validateStripeSignature(signature) {\n  if (!signature || typeof signature !== 'string') {\n    throw new ValidationError('Invalid webhook signature format');\n  }\n\n  // Stripe signature format: t=timestamp,v1=signature\n  const parts = signature.split(',');\n  if (parts.length < 2) {\n    throw new ValidationError('Invalid webhook signature format');\n  }\n\n  const signatureParts = {};\n  for (const part of parts) {\n    const [key, value] = part.split('=');\n    if (!key || !value) {\n      throw new ValidationError('Invalid webhook signature format');\n    }\n    signatureParts[key] = value;\n  }\n\n  if (!signatureParts.t || !signatureParts.v1) {\n    throw new ValidationError('Missing required signature components');\n  }\n\n  // Validate timestamp is a number\n  const timestamp = parseInt(signatureParts.t);\n  if (isNaN(timestamp) || timestamp <= 0) {\n    throw new ValidationError('Invalid signature timestamp');\n  }\n\n  // Validate signature is hex string\n  if (!/^[a-f0-9]+$/i.test(signatureParts.v1)) {\n    throw new ValidationError('Invalid signature format');\n  }\n\n  return signatureParts;\n}\n\n/**\n * Validate base64 encoded image\n */\nexport function validateBase64Image(base64String, fieldName = 'image') {\n  if (!base64String || typeof base64String !== 'string') {\n    throw new ValidationError(`${fieldName} must be a string`, fieldName);\n  }\n\n  // Check for data URI format\n  const dataUriMatch = base64String.match(/^data:image\\/(png|jpeg|jpg|gif|webp);base64,(.+)$/);\n\n  if (!dataUriMatch) {\n    throw new ValidationError(`${fieldName} must be a valid base64 data URI`, fieldName);\n  }\n\n  const base64Data = dataUriMatch[2];\n\n  // Validate base64 format\n  if (!/^[A-Za-z0-9+/]*={0,2}$/.test(base64Data)) {\n    throw new ValidationError(`${fieldName} contains invalid base64 characters`, fieldName);\n  }\n\n  // Size check (max 5MB)\n  const sizeInBytes = (base64Data.length * 3) / 4;\n  if (sizeInBytes > 5 * 1024 * 1024) {\n    throw new ValidationError(`${fieldName} is too large (max 5MB)`, fieldName);\n  }\n\n  return base64String;\n}\n", "/**\n * Structured Logging System\n * Provides consistent, searchable logging across the application\n */\n\n/**\n * Log levels\n */\nexport const LogLevel = {\n  DEBUG: 'DEBUG',\n  INFO: 'INFO',\n  WARN: 'WARN',\n  ERROR: 'ERROR',\n  SECURITY: 'SECURITY',\n  AUDIT: 'AUDIT'\n};\n\n/**\n * Logger class with structured output\n */\nexport class Logger {\n  constructor(env, context = {}) {\n    this.env = env;\n    this.context = context;\n    this.minLevel = env?.LOG_LEVEL || 'INFO';\n  }\n\n  /**\n   * Format log entry with structured data\n   */\n  formatLog(level, message, data = {}) {\n    const timestamp = new Date().toISOString();\n\n    const logEntry = {\n      timestamp,\n      level,\n      message,\n      ...this.context,\n      ...data\n    };\n\n    // Add environment info in development\n    if (this.env?.ENVIRONMENT === 'development') {\n      logEntry.env = 'development';\n    }\n\n    return logEntry;\n  }\n\n  /**\n   * Check if log level should be output\n   */\n  shouldLog(level) {\n    const levels = ['DEBUG', 'INFO', 'WARN', 'ERROR', 'SECURITY', 'AUDIT'];\n    const minIndex = levels.indexOf(this.minLevel);\n    const currentIndex = levels.indexOf(level);\n    return currentIndex >= minIndex;\n  }\n\n  /**\n   * Output log to console\n   */\n  output(logEntry) {\n    const { level, ...data } = logEntry;\n\n    switch (level) {\n      case LogLevel.ERROR:\n      case LogLevel.SECURITY:\n        console.error(JSON.stringify(logEntry));\n        break;\n      case LogLevel.WARN:\n        console.warn(JSON.stringify(logEntry));\n        break;\n      default:\n        console.log(JSON.stringify(logEntry));\n    }\n  }\n\n  /**\n   * Debug log\n   */\n  debug(message, data = {}) {\n    if (!this.shouldLog(LogLevel.DEBUG)) return;\n    this.output(this.formatLog(LogLevel.DEBUG, message, data));\n  }\n\n  /**\n   * Info log\n   */\n  info(message, data = {}) {\n    if (!this.shouldLog(LogLevel.INFO)) return;\n    this.output(this.formatLog(LogLevel.INFO, message, data));\n  }\n\n  /**\n   * Warning log\n   */\n  warn(message, data = {}) {\n    if (!this.shouldLog(LogLevel.WARN)) return;\n    this.output(this.formatLog(LogLevel.WARN, message, data));\n  }\n\n  /**\n   * Error log\n   */\n  error(message, error = null, data = {}) {\n    const errorData = {\n      ...data\n    };\n\n    if (error) {\n      errorData.error = {\n        message: error.message,\n        name: error.name,\n        stack: error.stack\n      };\n    }\n\n    this.output(this.formatLog(LogLevel.ERROR, message, errorData));\n  }\n\n  /**\n   * Security event log\n   */\n  security(message, data = {}) {\n    this.output(this.formatLog(LogLevel.SECURITY, message, {\n      ...data,\n      severity: 'high'\n    }));\n  }\n\n  /**\n   * Audit log for critical business events\n   */\n  audit(action, data = {}) {\n    this.output(this.formatLog(LogLevel.AUDIT, action, {\n      ...data,\n      auditEvent: true\n    }));\n  }\n\n  /**\n   * Create child logger with additional context\n   */\n  child(additionalContext) {\n    return new Logger(this.env, {\n      ...this.context,\n      ...additionalContext\n    });\n  }\n}\n\n/**\n * Request logger middleware\n * Adds request-specific context to all logs\n */\nexport function createRequestLogger(env, request) {\n  const url = new URL(request.url);\n\n  const context = {\n    requestId: crypto.randomUUID(),\n    method: request.method,\n    path: url.pathname,\n    userAgent: request.headers.get('User-Agent') || 'unknown',\n    origin: request.headers.get('Origin') || 'unknown',\n    ip: request.headers.get('CF-Connecting-IP') ||\n        request.headers.get('X-Forwarded-For') ||\n        'unknown'\n  };\n\n  return new Logger(env, context);\n}\n\n/**\n * Log authentication event\n */\nexport function logAuth(logger, success, userId = null, method = 'license_key') {\n  if (success) {\n    logger.audit('authentication_success', {\n      userId,\n      method\n    });\n  } else {\n    logger.security('authentication_failed', {\n      userId,\n      method,\n      reason: 'invalid_credentials'\n    });\n  }\n}\n\n/**\n * Log license key creation\n */\nexport function logLicenseCreation(logger, userId, email, tier) {\n  logger.audit('license_created', {\n    userId,\n    email,\n    tier,\n    action: 'create_license'\n  });\n}\n\n/**\n * Log subscription event\n */\nexport function logSubscription(logger, action, data = {}) {\n  logger.audit(`subscription_${action}`, {\n    ...data,\n    category: 'subscription'\n  });\n}\n\n/**\n * Log API usage\n */\nexport function logApiUsage(logger, endpoint, userId, tier, responseTime) {\n  logger.info('api_request', {\n    endpoint,\n    userId,\n    tier,\n    responseTime,\n    category: 'usage'\n  });\n}\n\n/**\n * Log rate limit event\n */\nexport function logRateLimit(logger, userId, tier, limit, current) {\n  logger.warn('rate_limit_approached', {\n    userId,\n    tier,\n    limit,\n    current,\n    percentage: Math.round((current / limit) * 100)\n  });\n}\n\n/**\n * Log rate limit exceeded\n */\nexport function logRateLimitExceeded(logger, userId, tier) {\n  logger.security('rate_limit_exceeded', {\n    userId,\n    tier,\n    action: 'blocked'\n  });\n}\n\n/**\n * Log validation error\n */\nexport function logValidationError(logger, field, error) {\n  logger.warn('validation_error', {\n    field,\n    error: error.message,\n    category: 'validation'\n  });\n}\n\n/**\n * Log database operation\n */\nexport function logDatabaseOp(logger, operation, table, duration = null) {\n  const data = {\n    operation,\n    table,\n    category: 'database'\n  };\n\n  if (duration !== null) {\n    data.duration = duration;\n  }\n\n  logger.debug('database_operation', data);\n}\n\n/**\n * Log webhook event\n */\nexport function logWebhook(logger, event, success, data = {}) {\n  if (success) {\n    logger.audit('webhook_processed', {\n      event,\n      ...data,\n      category: 'webhook'\n    });\n  } else {\n    logger.error('webhook_failed', null, {\n      event,\n      ...data,\n      category: 'webhook'\n    });\n  }\n}\n\n/**\n * Log CORS rejection\n */\nexport function logCorsRejection(logger, origin) {\n  logger.security('cors_rejected', {\n    origin,\n    reason: 'origin_not_allowed'\n  });\n}\n\n/**\n * Sanitize sensitive data from logs\n */\nexport function sanitizeLogData(data) {\n  const sanitized = { ...data };\n\n  // Remove sensitive fields\n  const sensitiveFields = [\n    'password',\n    'token',\n    'apiKey',\n    'secret',\n    'licenseKey',\n    'stripeKey',\n    'creditCard'\n  ];\n\n  for (const field of sensitiveFields) {\n    if (field in sanitized) {\n      sanitized[field] = '[REDACTED]';\n    }\n  }\n\n  // Redact partial license key (show only last 4 chars)\n  if (sanitized.license_key && typeof sanitized.license_key === 'string') {\n    const key = sanitized.license_key;\n    sanitized.license_key = `****-****-****-****-${key.slice(-4)}`;\n  }\n\n  // Recursively sanitize nested objects\n  for (const [key, value] of Object.entries(sanitized)) {\n    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\n      sanitized[key] = sanitizeLogData(value);\n    }\n  }\n\n  return sanitized;\n}\n", "/**\n * License Key Authentication Handler\n * Handles license key validation and user management\n */\n\nimport { jsonResponse, parseJSON, generateUUID } from './utils';\nimport { validateRequestBody, validateEmail, validateLicenseKey, ValidationError } from './validation';\nimport { logAuth, logLicenseCreation, logValidationError } from './logger';\n\nexport class AuthHandler {\n  constructor(env, logger = null) {\n    this.env = env;\n    this.db = env.DB;\n    this.logger = logger;\n  }\n\n  /**\n   * Generate a unique license key\n   * Format: XXXX-XXXX-XXXX-XXXX-XXXX\n   */\n  generateLicenseKey() {\n    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing chars like I, O, 0, 1\n    const segments = 5;\n    const segmentLength = 4;\n\n    let key = '';\n    for (let i = 0; i < segments; i++) {\n      if (i > 0) key += '-';\n      for (let j = 0; j < segmentLength; j++) {\n        key += chars.charAt(Math.floor(Math.random() * chars.length));\n      }\n    }\n\n    return key;\n  }\n\n  /**\n   * Validate and activate license key\n   * POST /api/auth/validate-key\n   */\n  async validateKey(request) {\n    try {\n      const body = await validateRequestBody(request);\n      const normalizedKey = validateLicenseKey(body.licenseKey, true);\n\n      // Find user by license key\n      const user = await this.db\n        .prepare('SELECT * FROM users WHERE license_key = ?')\n        .bind(normalizedKey)\n        .first();\n\n      if (!user) {\n        if (this.logger) logAuth(this.logger, false, null);\n        return jsonResponse({ error: 'Invalid license key' }, 401);\n      }\n\n      // Update last validated timestamp\n      await this.db\n        .prepare('UPDATE users SET last_validated_at = datetime(\\'now\\') WHERE id = ?')\n        .bind(user.id)\n        .run();\n\n      if (this.logger) logAuth(this.logger, true, user.id);\n\n      return jsonResponse({\n        message: 'License key validated successfully',\n        user: {\n          id: user.id,\n          email: user.email,\n          tier: user.tier,\n          subscriptionStatus: user.subscription_status,\n          licenseKey: user.license_key\n        }\n      });\n\n    } catch (error) {\n      if (this.logger) this.logger.error('License validation error', error);\n      if (error instanceof ValidationError) {\n        if (this.logger) logValidationError(this.logger, error.field, error);\n        return jsonResponse({ error: error.message, field: error.field }, 400);\n      }\n      return jsonResponse({ error: 'Validation failed' }, 500);\n    }\n  }\n\n  /**\n   * Get user info by license key\n   * Used internally by other handlers\n   */\n  async getUserByLicenseKey(licenseKey) {\n    try {\n      const normalizedKey = licenseKey.replace(/\\s+/g, '').toUpperCase();\n\n      const user = await this.db\n        .prepare('SELECT * FROM users WHERE license_key = ?')\n        .bind(normalizedKey)\n        .first();\n\n      return user;\n    } catch (error) {\n      console.error('Get user error:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Authenticate request using license key in header\n   * Header: Authorization: LicenseKey YOUR-KEY-HERE\n   */\n  async authenticate(request) {\n    try {\n      const authHeader = request.headers.get('Authorization');\n      if (!authHeader || !authHeader.startsWith('LicenseKey ')) {\n        return null;\n      }\n\n      const licenseKey = authHeader.substring(11); // Remove 'LicenseKey '\n      const user = await this.getUserByLicenseKey(licenseKey);\n\n      if (!user) {\n        return null;\n      }\n\n      // Return user data in JWT-like format for compatibility\n      return {\n        userId: user.id,\n        email: user.email,\n        tier: user.tier,\n        licenseKey: user.license_key\n      };\n\n    } catch (error) {\n      console.error('Authentication error:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Get current user info\n   * GET /api/auth/me\n   */\n  async getCurrentUser(request) {\n    try {\n      const user = await this.authenticate(request);\n      if (!user) {\n        return jsonResponse({ error: 'Not authenticated' }, 401);\n      }\n\n      // Get full user data\n      const userData = await this.db\n        .prepare('SELECT id, email, tier, license_key, subscription_status, created_at FROM users WHERE id = ?')\n        .bind(user.userId)\n        .first();\n\n      if (!userData) {\n        return jsonResponse({ error: 'User not found' }, 404);\n      }\n\n      return jsonResponse({\n        id: userData.id,\n        email: userData.email,\n        tier: userData.tier,\n        licenseKey: userData.license_key,\n        subscriptionStatus: userData.subscription_status,\n        createdAt: userData.created_at\n      });\n\n    } catch (error) {\n      console.error('Get user error:', error);\n      return jsonResponse({ error: 'Failed to fetch user' }, 500);\n    }\n  }\n\n  /**\n   * Create a new free license key\n   * POST /api/auth/create-free-key\n   * Required: email - to prevent abuse and track free tier users\n   */\n  async createFreeKey(request) {\n    try {\n      const body = await validateRequestBody(request);\n      const normalizedEmail = validateEmail(body.email, true);\n\n      // Check if email already has a free key\n      const existingUser = await this.db\n        .prepare('SELECT license_key, tier FROM users WHERE LOWER(email) = ? AND tier = ?')\n        .bind(normalizedEmail, 'free')\n        .first();\n\n      if (existingUser) {\n        // Return existing free key instead of creating a new one\n        return jsonResponse({\n          message: 'Using existing free license key for this email',\n          licenseKey: existingUser.license_key,\n          tier: 'free',\n          existing: true\n        }, 200);\n      }\n\n      // Generate unique license key\n      let licenseKey;\n      let attempts = 0;\n      const maxAttempts = 10;\n\n      while (attempts < maxAttempts) {\n        licenseKey = this.generateLicenseKey();\n\n        // Check if key already exists\n        const existing = await this.db\n          .prepare('SELECT id FROM users WHERE license_key = ?')\n          .bind(licenseKey)\n          .first();\n\n        if (!existing) break;\n        attempts++;\n      }\n\n      if (attempts >= maxAttempts) {\n        return jsonResponse({ error: 'Failed to generate unique license key' }, 500);\n      }\n\n      // Create user with free tier\n      const userId = generateUUID();\n      await this.db\n        .prepare('INSERT INTO users (id, license_key, email, tier, subscription_status) VALUES (?, ?, ?, ?, ?)')\n        .bind(userId, licenseKey, normalizedEmail, 'free', 'inactive')\n        .run();\n\n      if (this.logger) logLicenseCreation(this.logger, userId, normalizedEmail, 'free');\n\n      // If email service configured, send the key\n      if (this.env.RESEND_API_KEY) {\n        await this.sendLicenseKeyEmail(normalizedEmail, licenseKey, 'free');\n      }\n\n      return jsonResponse({\n        message: 'Free license key created successfully',\n        licenseKey: licenseKey,\n        tier: 'free'\n      }, 201);\n\n    } catch (error) {\n      if (this.logger) this.logger.error('Create free key error', error);\n      if (error instanceof ValidationError) {\n        if (this.logger) logValidationError(this.logger, error.field, error);\n        return jsonResponse({ error: error.message, field: error.field }, 400);\n      }\n      return jsonResponse({ error: 'Failed to create license key' }, 500);\n    }\n  }\n\n  /**\n   * Send license key via email using Resend\n   */\n  async sendLicenseKeyEmail(email, licenseKey, tier) {\n    try {\n      // Check if Resend is configured\n      if (!this.env.RESEND_API_KEY) {\n        console.warn('Resend API key not configured, skipping email');\n        return;\n      }\n\n      const subject = tier === 'pro'\n        ? 'Your CaptureAI Pro License Key'\n        : 'Your CaptureAI Free License Key';\n\n      // Plain text version (prevents spam filtering)\n      const textContent = tier === 'pro'\n        ? `Welcome to CaptureAI Pro!\n\nThank you for upgrading to CaptureAI Pro!\n\nYOUR LICENSE KEY:\n${licenseKey}\n\nHow to activate:\n1. Open the CaptureAI extension\n2. Click \"Enter License Key\"\n3. Copy and paste your license key above\n4. Start using CaptureAI!\n\nPro Features:\n- Unlimited requests (60 per minute)\n- GPT-5 Nano AI model\n- Priority support\n\nKeep this email safe - you'll need your license key to use CaptureAI.\n\n---\nCaptureAI - AI-Powered Screenshot Analysis\nhttps://thesuperiorflash.github.io/CaptureAI`\n        : `Welcome to CaptureAI!\n\nThank you for trying CaptureAI!\n\nYOUR LICENSE KEY:\n${licenseKey}\n\nHow to activate:\n1. Open the CaptureAI extension\n2. Click \"Enter License Key\"\n3. Copy and paste your license key above\n4. Start using CaptureAI!\n\nFree tier includes 10 requests per day. Upgrade to Pro for unlimited access!\n\nKeep this email safe - you'll need your license key to use CaptureAI.\n\n---\nCaptureAI - AI-Powered Screenshot Analysis\nhttps://thesuperiorflash.github.io/CaptureAI`;\n\n      // HTML version with proper structure\n      const htmlContent = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${subject}</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f4f4; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\">\n  <table role=\"presentation\" style=\"width: 100%; border-collapse: collapse;\">\n    <tr>\n      <td style=\"padding: 40px 0;\">\n        <table role=\"presentation\" style=\"width: 100%; max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <!-- Header -->\n          <tr>\n            <td style=\"padding: 40px 40px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px 8px 0 0;\">\n              <h1 style=\"margin: 0; color: #ffffff; font-size: 28px; font-weight: 600;\">\n                CaptureAI ${tier === 'pro' ? 'Pro' : ''}\n              </h1>\n            </td>\n          </tr>\n\n          <!-- Main Content -->\n          <tr>\n            <td style=\"padding: 40px;\">\n              <h2 style=\"margin: 0 0 20px; color: #333333; font-size: 24px; font-weight: 600;\">\n                Welcome to CaptureAI!\n              </h2>\n              <p style=\"margin: 0 0 20px; color: #555555; font-size: 16px; line-height: 1.6;\">\n                Thank you for ${tier === 'pro' ? 'upgrading to CaptureAI Pro' : 'trying CaptureAI'}! Here's your license key to get started.\n              </p>\n\n              <!-- License Key Box -->\n              <table role=\"presentation\" style=\"width: 100%; border-collapse: collapse; margin: 30px 0;\">\n                <tr>\n                  <td style=\"background-color: #f8f9fa; padding: 30px; border-radius: 8px; border: 2px solid #e9ecef; text-align: center;\">\n                    <p style=\"margin: 0 0 10px; color: #666666; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;\">\n                      Your License Key\n                    </p>\n                    <p style=\"margin: 0; font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold; color: #667eea; letter-spacing: 2px; word-break: break-all;\">\n                      ${licenseKey}\n                    </p>\n                  </td>\n                </tr>\n              </table>\n\n              <!-- Instructions -->\n              <h3 style=\"margin: 30px 0 15px; color: #333333; font-size: 18px; font-weight: 600;\">\n                How to activate:\n              </h3>\n              <ol style=\"margin: 0; padding-left: 20px; color: #555555; font-size: 16px; line-height: 1.8;\">\n                <li>Open the CaptureAI Chrome extension</li>\n                <li>Click \"Enter License Key\"</li>\n                <li>Copy and paste your license key from above</li>\n                <li>Start using CaptureAI!</li>\n              </ol>\n\n              ${tier === 'pro' ? `\n              <!-- Pro Features -->\n              <table role=\"presentation\" style=\"width: 100%; border-collapse: collapse; margin: 30px 0;\">\n                <tr>\n                  <td style=\"background: linear-gradient(135deg, #e3f2fd 0%, #e8eaf6 100%); padding: 25px; border-radius: 8px;\">\n                    <h3 style=\"margin: 0 0 15px; color: #333333; font-size: 18px; font-weight: 600;\">\n                      Your Pro Features:\n                    </h3>\n                    <ul style=\"margin: 0; padding-left: 20px; color: #555555; font-size: 16px; line-height: 1.8;\">\n                      <li>Unlimited requests (60 per minute)</li>\n                      <li>GPT-5 Nano AI model</li>\n                      <li>Priority support</li>\n                    </ul>\n                  </td>\n                </tr>\n              </table>\n              ` : `\n              <p style=\"margin: 30px 0 0; padding: 20px; background-color: #fff3cd; border-left: 4px solid #ffc107; color: #856404; font-size: 14px; line-height: 1.6; border-radius: 4px;\">\n                <strong>Free tier includes 10 requests per day.</strong><br>\n                Upgrade to Pro for unlimited access!\n              </p>\n              `}\n            </td>\n          </tr>\n\n          <!-- Footer -->\n          <tr>\n            <td style=\"padding: 30px 40px; background-color: #f8f9fa; border-radius: 0 0 8px 8px; border-top: 1px solid #e9ecef;\">\n              <p style=\"margin: 0 0 10px; color: #666666; font-size: 14px; line-height: 1.6; text-align: center;\">\n                <strong>Keep this email safe</strong> - you'll need your license key to use CaptureAI.\n              </p>\n              <p style=\"margin: 0; color: #999999; font-size: 12px; text-align: center;\">\n                CaptureAI - AI-Powered Screenshot Analysis<br>\n                <a href=\"https://thesuperiorflash.github.io/CaptureAI\" style=\"color: #667eea; text-decoration: none;\">Visit our website</a>\n              </p>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n\n      // Send via Resend\n      await this.sendEmailViaResend(email, subject, htmlContent, textContent, tier);\n\n    } catch (error) {\n      console.error('Email sending error:', error);\n      // Don't throw - email is not critical\n    }\n  }\n\n  /**\n   * Send email via Resend\n   */\n  async sendEmailViaResend(email, subject, htmlContent, textContent, tier = 'free') {\n    console.log('Attempting to send email via Resend to:', email);\n\n    const response = await fetch('https://api.resend.com/emails', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.env.RESEND_API_KEY}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        from: this.env.FROM_EMAIL || 'CaptureAI <noreply@captureai.app>',\n        to: [email],\n        subject: subject,\n        html: htmlContent,\n        text: textContent,\n        headers: {\n          'X-Entity-Ref-ID': crypto.randomUUID(),\n        },\n        tags: [\n          {\n            name: 'category',\n            value: tier === 'pro' ? 'license_pro' : 'license_free'\n          }\n        ]\n      })\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      if (this.logger) {\n        this.logger.error('Resend email error', null, { error: errorText });\n      }\n      console.error('Resend error:', errorText);\n    } else {\n      if (this.logger) {\n        this.logger.info('Email sent successfully', { provider: 'resend', to: email });\n      }\n    }\n  }\n\n}\n", "/**\n * AI Handler\n * Handles AI requests through Cloudflare AI Gateway\n */\n\nimport { jsonResponse, parseJSON } from './utils';\nimport { AuthHandler } from './auth';\n\nexport class AIHandler {\n  constructor(env) {\n    this.env = env;\n    this.db = env.DB;\n    this.auth = new AuthHandler(env);\n    this.gatewayName = env.CLOUDFLARE_GATEWAY_NAME || 'captureai-gateway';\n\n    // Get account ID from env or extract from worker URL\n    this.accountId = env.CLOUDFLARE_ACCOUNT_ID || this.extractAccountId(env);\n\n    // Build gateway URL using provider-specific endpoint\n    // Cloudflare docs: https://gateway.ai.cloudflare.com/v1/{account_id}/{gateway_id}/{provider}\n    // For OpenAI, we append the OpenAI API path after the provider\n    this.apiUrl = `https://gateway.ai.cloudflare.com/v1/${this.accountId}/${this.gatewayName}/compat/v1/chat/completions`;\n  }\n\n  extractAccountId(env) {\n    // Account ID should be set in wrangler.toml\n    // This is a fallback\n    return env.CLOUDFLARE_ACCOUNT_ID || 'YOUR_ACCOUNT_ID';\n  }\n\n  /**\n   * AI solve request (alias for complete)\n   * POST /api/ai/solve\n   */\n  async solve(request) {\n    return this.complete(request);\n  }\n\n  /**\n   * AI completion request\n   * POST /api/ai/complete\n   */\n  async complete(request) {\n    try {\n      // Authenticate\n      const user = await this.auth.authenticate(request);\n      if (!user) {\n        return jsonResponse({ error: 'Not authenticated' }, 401);\n      }\n\n      // Check usage limit\n      const usageCheck = await this.checkUsageLimit(user.userId, user.tier);\n      if (!usageCheck.allowed) {\n        const errorMessage = usageCheck.limitType === 'per_minute'\n          ? 'Rate limit reached. Please wait a moment before trying again.'\n          : 'Daily limit reached';\n\n        return jsonResponse({\n          error: errorMessage,\n          limit: usageCheck.limit,\n          used: usageCheck.used,\n          tier: user.tier,\n          limitType: usageCheck.limitType\n        }, 429);\n      }\n\n      // Parse request\n      const { question, imageData, promptType, reasoningLevel } = await parseJSON(request);\n\n      // Validate\n      if (!question && !imageData) {\n        return jsonResponse({ error: 'Question or image data required' }, 400);\n      }\n\n      // Build OpenAI payload\n      const payload = this.buildPayload({\n        question,\n        imageData,\n        promptType: promptType || 'answer'\n      }, reasoningLevel || 1);\n\n      // Send to AI Gateway\n      const startTime = Date.now();\n      const aiResponse = await this.sendToGateway(payload, user.userId);\n      const responseTime = Date.now() - startTime;\n\n      // Extract answer\n      const answer = aiResponse.choices[0]?.message?.content?.trim() || 'No response found';\n\n      // Record usage\n      await this.recordUsage({\n        userId: user.userId,\n        promptType: promptType || 'answer',\n        model: payload.model,\n        tokensUsed: aiResponse.usage?.total_tokens || 0,\n        responseTime,\n        cached: aiResponse.cached || false\n      });\n\n      return jsonResponse({\n        answer,\n        usage: {\n          tokensUsed: aiResponse.usage?.total_tokens || 0,\n          remainingToday: usageCheck.limitType === 'per_day' ? usageCheck.limit - usageCheck.used - 1 : null,\n          dailyLimit: usageCheck.limitType === 'per_day' ? usageCheck.limit : null,\n          usedToday: usageCheck.limitType === 'per_day' ? usageCheck.used + 1 : null,\n          limitType: usageCheck.limitType\n        },\n        cached: aiResponse.cached || false,\n        responseTime,\n        model: payload.model\n      });\n\n    } catch (error) {\n      console.error('AI completion error:', error);\n      return jsonResponse({\n        error: 'AI request failed',\n        message: error.message\n      }, 500);\n    }\n  }\n\n  /**\n   * Get usage statistics\n   * GET /api/ai/usage\n   */\n  async getUsage(request) {\n    try {\n      const user = await this.auth.authenticate(request);\n      if (!user) {\n        return jsonResponse({ error: 'Not authenticated' }, 401);\n      }\n\n      // Get today's usage\n      const today = new Date().toISOString().split('T')[0];\n      const usageToday = await this.db\n        .prepare(`\n          SELECT COUNT(*) as count\n          FROM usage_records\n          WHERE user_id = ? AND DATE(created_at) = ?\n        `)\n        .bind(user.userId, today)\n        .first();\n\n      const used = usageToday?.count || 0;\n\n      // Free tier: 10/day, Pro tier: unlimited daily (rate limited per minute)\n      if (user.tier === 'pro') {\n        // For Pro users, show per-minute usage\n        const oneMinuteAgo = new Date(Date.now() - 60000).toISOString();\n        const usageLastMinute = await this.db\n          .prepare(`\n            SELECT COUNT(*) as count\n            FROM usage_records\n            WHERE user_id = ? AND created_at > ?\n          `)\n          .bind(user.userId, oneMinuteAgo)\n          .first();\n\n        const usedLastMinute = usageLastMinute?.count || 0;\n        const rateLimit = parseInt(this.env.PRO_TIER_RATE_LIMIT_PER_MINUTE || '60');\n\n        return jsonResponse({\n          today: {\n            used,\n            limit: null,  // Unlimited daily\n            remaining: null,\n            percentage: 0\n          },\n          lastMinute: {\n            used: usedLastMinute,\n            limit: rateLimit,\n            remaining: Math.max(0, rateLimit - usedLastMinute),\n            percentage: Math.round((usedLastMinute / rateLimit) * 100)\n          },\n          tier: user.tier,\n          limitType: 'per_minute'\n        });\n      } else {\n        // Free tier\n        const dailyLimit = parseInt(this.env.FREE_TIER_DAILY_LIMIT || '10');\n\n        return jsonResponse({\n          today: {\n            used,\n            limit: dailyLimit,\n            remaining: Math.max(0, dailyLimit - used),\n            percentage: Math.round((used / dailyLimit) * 100)\n          },\n          tier: user.tier,\n          limitType: 'per_day'\n        });\n      }\n\n    } catch (error) {\n      console.error('Usage fetch error:', error);\n      return jsonResponse({ error: 'Failed to fetch usage' }, 500);\n    }\n  }\n\n  /**\n   * Get available models\n   * GET /api/ai/models\n   */\n  async getModels(request) {\n    return jsonResponse({\n      models: [\n        {\n          id: 'gpt-5-nano',\n          name: 'GPT-5 Nano',\n          description: 'Fast and efficient reasoning',\n          tier: 'all'\n        }\n      ]\n    });\n  }\n\n  /**\n   * Check if user is within usage limits\n   */\n  async checkUsageLimit(userId, tier) {\n    // Pro tier: Rate limited to 30 requests per minute\n    if (tier === 'pro') {\n      const rateLimit = parseInt(this.env.PRO_TIER_RATE_LIMIT_PER_MINUTE || '30');\n\n      // Get requests from last minute\n      const oneMinuteAgo = new Date(Date.now() - 60000).toISOString();\n      const result = await this.db\n        .prepare(`\n          SELECT COUNT(*) as count\n          FROM usage_records\n          WHERE user_id = ? AND created_at > ?\n        `)\n        .bind(userId, oneMinuteAgo)\n        .first();\n\n      const usedInLastMinute = result?.count || 0;\n\n      return {\n        allowed: usedInLastMinute < rateLimit,\n        used: usedInLastMinute,\n        limit: rateLimit,\n        limitType: 'per_minute'\n      };\n    }\n\n    // Free tier has daily limit\n    const limit = parseInt(this.env.FREE_TIER_DAILY_LIMIT || '10');\n\n    // Get today's usage\n    const today = new Date().toISOString().split('T')[0];\n    const result = await this.db\n      .prepare(`\n        SELECT COUNT(*) as count\n        FROM usage_records\n        WHERE user_id = ? AND DATE(created_at) = ?\n      `)\n      .bind(userId, today)\n      .first();\n\n    const used = result?.count || 0;\n\n    return {\n      allowed: used < limit,\n      used,\n      limit,\n      limitType: 'per_day'\n    };\n  }\n\n  /**\n   * Record usage in database\n   */\n  async recordUsage({ userId, promptType, model, tokensUsed, responseTime, cached }) {\n    await this.db\n      .prepare(`\n        INSERT INTO usage_records (user_id, prompt_type, model, tokens_used, response_time, cached)\n        VALUES (?, ?, ?, ?, ?, ?)\n      `)\n      .bind(userId, promptType, model, tokensUsed, responseTime, cached ? 1 : 0)\n      .run();\n  }\n\n  /**\n   * Build OpenAI payload\n   */\n  buildPayload(requestData, reasoningLevel) {\n    const { question, imageData, promptType } = requestData;\n\n    // Reasoning level configurations\n    // 0 = Low (gpt-4.1-nano, no reasoning)\n    // 1 = Medium (gpt-5-nano, low reasoning)\n    // 2 = High (gpt-5-nano, medium reasoning)\n    const configs = {\n      0: { model: 'openai/gpt-4.1-nano', reasoningEffort: null },  // Legacy model, no reasoning\n      1: { model: 'openai/gpt-5-nano', reasoningEffort: 'low' },\n      2: { model: 'openai/gpt-5-nano', reasoningEffort: 'medium' }\n    };\n\n    const config = configs[reasoningLevel] || configs[1]; // Default to medium\n\n    let messages = [];\n\n    if (promptType === 'ask' && question && imageData) {\n      messages = [{\n        role: 'user',\n        content: [\n          { type: 'text', text: question },\n          { type: 'image_url', image_url: { url: imageData } }\n        ]\n      }];\n    } else if (promptType === 'ask' && question) {\n      messages = [\n        { role: 'system', content: 'You are a helpful assistant.' },\n        { role: 'user', content: question }\n      ];\n    } else if (promptType === 'auto_solve' && imageData) {\n      messages = [{\n        role: 'user',\n        content: [\n          { type: 'text', text: 'Answer with only the number (1, 2, 3, or 4) of the correct choice.' },\n          { type: 'image_url', image_url: { url: imageData } }\n        ]\n      }];\n    } else {\n      messages = [{\n        role: 'user',\n        content: [\n          { type: 'text', text: 'Reply with answer only.' },\n          { type: 'image_url', image_url: { url: imageData } }\n        ]\n      }];\n    }\n\n    const payload = {\n        model: config.model,\n        messages\n    };\n\n    // Use different token parameter based on model\n    const maxTokens = promptType === 'ask' ? 4000 : 2500;\n\n    if (config.useLegacyTokenParam) {\n        // gpt-4.1-mini uses max_tokens\n        payload.max_tokens = maxTokens;\n    } else {\n        // gpt-5-nano uses max_completion_tokens\n        payload.max_completion_tokens = maxTokens;\n    }\n\n    // Add reasoning_effort only for gpt-5-nano models (level 1 and 2)\n    if (config.reasoningEffort) {\n        payload.reasoning_effort = config.reasoningEffort;\n    }\n\n    return payload;\n}\n\n  /**\n   * Send request to Cloudflare AI Gateway\n   */\n  async sendToGateway(payload, userId) {\n      const headers = {\n          'Content-Type': 'application/json',\n          'cf-aig-metadata-user': userId\n      };\n\n      // Add gateway token if using authenticated AI Gateway\n      if (this.env.CLOUDFLARE_GATEWAY_TOKEN) {\n          headers['cf-aig-authorization'] = this.env.CLOUDFLARE_GATEWAY_TOKEN;\n      }\n\n      const response = await fetch(this.apiUrl, {\n          method: 'POST',\n          headers,\n      body: JSON.stringify(payload)\n    });\n\n    if (!response.ok) {\n      const error = await response.json().catch(() => ({}));\n      throw new Error(`OpenAI error (${response.status}): ${error.error?.message || response.statusText}`);\n    }\n\n    const data = await response.json();\n\n    // Check if cached\n    const cfCacheStatus = response.headers.get('cf-cache-status');\n    if (cfCacheStatus === 'HIT') {\n      data.cached = true;\n    }\n\n    return data;\n  }\n}\n", "/**\n * Subscription Handler (License Key System)\n * Handles Stripe subscription payments and license key generation\n */\n\nimport { jsonResponse, parseJSON, generateUUID, constantTimeCompare } from './utils';\nimport { AuthHandler } from './auth';\nimport { validateRequestBody, validateEmail, validateStripeSignature, ValidationError } from './validation';\nimport { logSubscription, logWebhook, logValidationError } from './logger';\n\nexport class SubscriptionHandler {\n  constructor(env, logger = null) {\n    this.env = env;\n    this.db = env.DB;\n    this.auth = new AuthHandler(env, logger);\n    this.stripeKey = env.STRIPE_SECRET_KEY;\n    this.webhookSecret = env.STRIPE_WEBHOOK_SECRET;\n    this.logger = logger;\n  }\n\n  /**\n   * Create Stripe checkout session for Pro tier\n   * POST /api/subscription/create-checkout\n   */\n  async createCheckout(request) {\n    try {\n      const body = await validateRequestBody(request);\n      const email = validateEmail(body.email, true);\n\n      const priceId = this.env.STRIPE_PRICE_PRO;\n      if (!priceId) {\n        return jsonResponse({ error: 'Price not configured' }, 500);\n      }\n\n      // Create or get Stripe customer\n      let customerId;\n      const existingUser = await this.db\n        .prepare('SELECT stripe_customer_id FROM users WHERE email = ?')\n        .bind(email)\n        .first();\n\n      if (existingUser?.stripe_customer_id) {\n        customerId = existingUser.stripe_customer_id;\n      } else {\n        const customer = await this.createStripeCustomer(email);\n        customerId = customer.id;\n      }\n\n      // Create checkout session\n      const session = await this.createStripeCheckout(customerId, priceId, email);\n\n      if (this.logger) {\n        logSubscription(this.logger, 'checkout_created', {\n          email,\n          sessionId: session.id\n        });\n      }\n\n      return jsonResponse({\n        url: session.url,\n        sessionId: session.id\n      });\n\n    } catch (error) {\n      if (this.logger) this.logger.error('Checkout creation error', error);\n      if (error instanceof ValidationError) {\n        if (this.logger) logValidationError(this.logger, error.field, error);\n        return jsonResponse({ error: error.message, field: error.field }, 400);\n      }\n      return jsonResponse({ error: 'Failed to create checkout' }, 500);\n    }\n  }\n\n  /**\n   * Handle Stripe webhook events\n   * POST /api/subscription/webhook\n   */\n  async handleWebhook(request) {\n    try {\n      const signature = request.headers.get('stripe-signature');\n      const body = await request.text();\n\n      // Verify webhook signature for security\n      if (!signature || !this.webhookSecret) {\n        console.error('Missing signature or webhook secret');\n        return jsonResponse({ error: 'Webhook verification failed' }, 400);\n      }\n\n      // Verify the webhook signature\n      const event = await this.verifyWebhookSignature(body, signature);\n\n      switch (event.type) {\n        case 'checkout.session.completed': {\n          await this.handleCheckoutCompleted(event.data.object);\n          break;\n        }\n\n        case 'invoice.payment_succeeded': {\n          await this.handlePaymentSucceeded(event.data.object);\n          break;\n        }\n\n        case 'invoice.payment_failed': {\n          await this.handlePaymentFailed(event.data.object);\n          break;\n        }\n\n        case 'customer.subscription.deleted': {\n          await this.handleSubscriptionCancelled(event.data.object);\n          break;\n        }\n\n        case 'customer.subscription.updated': {\n          await this.handleSubscriptionUpdated(event.data.object);\n          break;\n        }\n      }\n\n      return jsonResponse({ received: true });\n\n    } catch (error) {\n      console.error('Webhook error:', error);\n      return jsonResponse({ error: 'Webhook failed' }, 500);\n    }\n  }\n\n  /**\n   * Handle successful checkout - generate and send license key\n   */\n  async handleCheckoutCompleted(session) {\n    try {\n      let customerEmail = session.customer_email || session.customer_details?.email;\n      const customerId = session.customer;\n      const subscriptionId = session.subscription;\n\n      // If email not in session, fetch from Stripe customer\n      if (!customerEmail && customerId) {\n        const customerResponse = await fetch(`https://api.stripe.com/v1/customers/${customerId}`, {\n          headers: {\n            'Authorization': `Bearer ${this.stripeKey}`\n          }\n        });\n\n        if (customerResponse.ok) {\n          const customer = await customerResponse.json();\n          customerEmail = customer.email;\n        }\n      }\n\n      if (!customerEmail) {\n        console.error('No customer email in checkout session or customer object');\n        return;\n      }\n\n      // Check if user already exists (by email OR stripe_customer_id)\n      let user = await this.db\n        .prepare('SELECT * FROM users WHERE email = ? OR stripe_customer_id = ?')\n        .bind(customerEmail, customerId)\n        .first();\n\n      if (user) {\n        // User exists - upgrade to pro\n        await this.db\n          .prepare(`\n            UPDATE users\n            SET tier = ?,\n                subscription_status = ?,\n                stripe_customer_id = ?,\n                stripe_subscription_id = ?,\n                updated_at = datetime('now')\n            WHERE id = ?\n          `)\n          .bind('pro', 'active', customerId, subscriptionId, user.id)\n          .run();\n\n        console.log(`Upgraded user ${customerEmail} to Pro tier`);\n\n        // Send upgrade email with existing license key\n        if (this.env.RESEND_API_KEY) {\n          await this.auth.sendLicenseKeyEmail(customerEmail, user.license_key, 'pro');\n        }\n\n      } else {\n        // New user - generate license key and create account\n        let licenseKey;\n        let attempts = 0;\n\n        while (attempts < 10) {\n          licenseKey = this.auth.generateLicenseKey();\n\n          const existing = await this.db\n            .prepare('SELECT id FROM users WHERE license_key = ?')\n            .bind(licenseKey)\n            .first();\n\n          if (!existing) break;\n          attempts++;\n        }\n\n        const userId = generateUUID();\n        await this.db\n          .prepare(`\n            INSERT INTO users (id, license_key, email, tier, stripe_customer_id, stripe_subscription_id, subscription_status)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n          `)\n          .bind(userId, licenseKey, customerEmail, 'pro', customerId, subscriptionId, 'active')\n          .run();\n\n        console.log(`Created new Pro user ${customerEmail} with license key`);\n\n        // Send welcome email with license key\n        if (this.env.RESEND_API_KEY) {\n          await this.auth.sendLicenseKeyEmail(customerEmail, licenseKey, 'pro');\n        }\n      }\n\n    } catch (error) {\n      console.error('Checkout completion error:', error);\n    }\n  }\n\n  /**\n   * Handle successful payment (monthly renewal)\n   */\n  async handlePaymentSucceeded(invoice) {\n    try {\n      const customerEmail = invoice.customer_email;\n\n      if (customerEmail) {\n        await this.db\n          .prepare('UPDATE users SET subscription_status = ?, tier = ? WHERE email = ?')\n          .bind('active', 'pro', customerEmail)\n          .run();\n      }\n    } catch (error) {\n      console.error('Payment succeeded handler error:', error);\n    }\n  }\n\n  /**\n   * Handle failed payment\n   */\n  async handlePaymentFailed(invoice) {\n    try {\n      const customerEmail = invoice.customer_email;\n\n      if (customerEmail) {\n        await this.db\n          .prepare('UPDATE users SET subscription_status = ? WHERE email = ?')\n          .bind('past_due', customerEmail)\n          .run();\n      }\n    } catch (error) {\n      console.error('Payment failed handler error:', error);\n    }\n  }\n\n  /**\n   * Handle subscription cancellation\n   */\n  async handleSubscriptionCancelled(subscription) {\n    try {\n      const subscriptionId = subscription.id;\n\n      await this.db\n        .prepare('UPDATE users SET tier = ?, subscription_status = ? WHERE stripe_subscription_id = ?')\n        .bind('free', 'cancelled', subscriptionId)\n        .run();\n    } catch (error) {\n      console.error('Subscription cancellation handler error:', error);\n    }\n  }\n\n  /**\n   * Handle subscription update\n   */\n  async handleSubscriptionUpdated(subscription) {\n    try {\n      const subscriptionId = subscription.id;\n      const status = subscription.status;\n\n      const newTier = status === 'active' ? 'pro' : 'free';\n      const subscriptionStatus = status === 'active' ? 'active' : 'inactive';\n\n      await this.db\n        .prepare('UPDATE users SET tier = ?, subscription_status = ? WHERE stripe_subscription_id = ?')\n        .bind(newTier, subscriptionStatus, subscriptionId)\n        .run();\n    } catch (error) {\n      console.error('Subscription update handler error:', error);\n    }\n  }\n\n  /**\n   * Get billing portal URL (for managing subscription)\n   * GET /api/subscription/portal\n   */\n  async getPortal(request) {\n    try {\n      const user = await this.auth.authenticate(request);\n      if (!user) {\n        return jsonResponse({ error: 'Not authenticated' }, 401);\n      }\n\n      const userData = await this.db\n        .prepare('SELECT stripe_customer_id FROM users WHERE id = ?')\n        .bind(user.userId)\n        .first();\n\n      if (!userData?.stripe_customer_id) {\n        return jsonResponse({ error: 'No subscription found' }, 400);\n      }\n\n      const portal = await this.createBillingPortal(userData.stripe_customer_id);\n\n      return jsonResponse({ url: portal.url });\n\n    } catch (error) {\n      console.error('Portal error:', error);\n      return jsonResponse({ error: 'Failed to create portal' }, 500);\n    }\n  }\n\n  /**\n   * Get available plans\n   * GET /api/subscription/plans\n   */\n  async getPlans(request) {\n    return jsonResponse({\n      plans: [\n        {\n          tier: 'free',\n          name: 'Free',\n          price: 0,\n          dailyLimit: parseInt(this.env.FREE_TIER_DAILY_LIMIT || '10'),\n          features: []\n        },\n        {\n          tier: 'pro',\n          name: 'Pro',\n          price: 9.99,\n          dailyLimit: null,\n          rateLimit: '60 per minute',\n          features: ['Unlimited requests', 'GPT-5 Nano', '60 requests/minute'],\n          recommended: true\n        }\n      ]\n    });\n  }\n\n  /**\n   * Create Stripe customer\n   */\n  async createStripeCustomer(email) {\n    const response = await fetch('https://api.stripe.com/v1/customers', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.stripeKey}`,\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: new URLSearchParams({\n        email: email\n      })\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      console.error('Stripe customer creation failed:', error);\n      throw new Error(error.error?.message || 'Failed to create Stripe customer');\n    }\n\n    return await response.json();\n  }\n\n  /**\n   * Create Stripe checkout session\n   */\n  async createStripeCheckout(customerId, priceId, email) {\n    const params = {\n      'line_items[0][price]': priceId,\n      'line_items[0][quantity]': '1',\n      mode: 'subscription',\n      success_url: `${this.env.EXTENSION_URL || 'https://thesuperiorflash.github.io/CaptureAI'}/payment-success.html?session_id={CHECKOUT_SESSION_ID}`,\n      cancel_url: `${this.env.EXTENSION_URL || 'https://thesuperiorflash.github.io/CaptureAI'}/activate.html`\n    };\n\n    // Use customer ID if available, otherwise use email\n    if (customerId) {\n      params.customer = customerId;\n    } else {\n      params.customer_email = email;\n    }\n\n    const response = await fetch('https://api.stripe.com/v1/checkout/sessions', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.stripeKey}`,\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: new URLSearchParams(params)\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      console.error('Stripe checkout creation failed:', error);\n      throw new Error(error.error?.message || 'Failed to create checkout session');\n    }\n\n    return await response.json();\n  }\n\n  /**\n   * Create billing portal session\n   */\n  async createBillingPortal(customerId) {\n    const response = await fetch('https://api.stripe.com/v1/billing_portal/sessions', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.stripeKey}`,\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      body: new URLSearchParams({\n        customer: customerId,\n        return_url: `${this.env.EXTENSION_URL || 'https://thesuperiorflash.github.io/CaptureAI'}/activate.html`\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error('Failed to create portal session');\n    }\n\n    return await response.json();\n  }\n\n  /**\n   * Verify Stripe webhook signature using HMAC SHA256\n   * Includes replay attack detection with processed event tracking\n   */\n  async verifyWebhookSignature(payload, signature) {\n    // Validate signature format first\n    const signatureParts = validateStripeSignature(signature);\n\n    const timestamp = signatureParts.t;\n    const expectedSignature = signatureParts.v1;\n\n    // Check timestamp to prevent replay attacks (tightened to 2 minutes)\n    const currentTime = Math.floor(Date.now() / 1000);\n    const timeDiff = currentTime - parseInt(timestamp);\n\n    if (timeDiff > 120) {\n      if (this.logger) {\n        this.logger.security('Webhook timestamp too old', {\n          timeDiff,\n          timestamp,\n          currentTime\n        });\n      }\n      throw new Error('Webhook timestamp too old (max 2 minutes)');\n    }\n\n    // Reject future timestamps (clock skew tolerance: 30 seconds)\n    if (timeDiff < -30) {\n      if (this.logger) {\n        this.logger.security('Webhook timestamp in future', {\n          timeDiff,\n          timestamp,\n          currentTime\n        });\n      }\n      throw new Error('Webhook timestamp is in the future');\n    }\n\n    // Construct signed payload\n    const signedPayload = `${timestamp}.${payload}`;\n\n    // Compute HMAC SHA256\n    const encoder = new TextEncoder();\n    const key = await crypto.subtle.importKey(\n      'raw',\n      encoder.encode(this.webhookSecret),\n      { name: 'HMAC', hash: 'SHA-256' },\n      false,\n      ['sign']\n    );\n\n    const signatureBytes = await crypto.subtle.sign(\n      'HMAC',\n      key,\n      encoder.encode(signedPayload)\n    );\n\n    const computedSignature = Array.from(new Uint8Array(signatureBytes))\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n\n    // Constant-time comparison to prevent timing attacks\n    if (!constantTimeCompare(computedSignature, expectedSignature)) {\n      if (this.logger) {\n        this.logger.security('Webhook signature verification failed');\n      }\n      throw new Error('Signature verification failed');\n    }\n\n    const event = JSON.parse(payload);\n\n    // Check for duplicate webhook processing (replay attack detection)\n    const eventId = event.id;\n    if (eventId) {\n      const processed = await this.checkWebhookProcessed(eventId);\n      if (processed) {\n        if (this.logger) {\n          this.logger.security('Duplicate webhook detected (replay attack)', {\n            eventId,\n            eventType: event.type\n          });\n        }\n        throw new Error('Webhook already processed');\n      }\n\n      // Mark event as processed\n      await this.markWebhookProcessed(eventId, timestamp);\n    }\n\n    return event;\n  }\n\n  /**\n   * Check if webhook event has been processed\n   */\n  async checkWebhookProcessed(eventId) {\n    try {\n      const result = await this.db\n        .prepare('SELECT id FROM webhook_events WHERE event_id = ?')\n        .bind(eventId)\n        .first();\n\n      return !!result;\n    } catch (error) {\n      // If table doesn't exist, event hasn't been processed\n      if (this.logger) {\n        this.logger.warn('Webhook tracking table may not exist', { error: error.message });\n      }\n      return false;\n    }\n  }\n\n  /**\n   * Mark webhook event as processed\n   */\n  async markWebhookProcessed(eventId, timestamp) {\n    try {\n      await this.db\n        .prepare('INSERT INTO webhook_events (event_id, processed_at, webhook_timestamp) VALUES (?, datetime(\\'now\\'), ?)')\n        .bind(eventId, timestamp)\n        .run();\n    } catch (error) {\n      if (this.logger) {\n        this.logger.error('Failed to mark webhook as processed', error, { eventId });\n      }\n    }\n  }\n}\n", "/**\n * Router - Handles request routing (License Key System)\n */\n\nimport { AuthHandler } from './auth';\nimport { AIHandler } from './ai';\nimport { SubscriptionHandler } from './subscription';\nimport { jsonResponse } from './utils';\n\nexport class Router {\n  constructor(env, logger = null) {\n    this.env = env;\n    this.logger = logger;\n    this.auth = new AuthHandler(env, logger);\n    this.ai = new AIHandler(env, logger);\n    this.subscription = new SubscriptionHandler(env, logger);\n  }\n\n  /**\n   * Route incoming request\n   */\n  async route(request) {\n    const url = new URL(request.url);\n    const path = url.pathname;\n    const method = request.method;\n\n    // Root / Health check\n    if (path === '/' && method === 'GET') {\n      return jsonResponse({\n        status: 'CaptureAI License Key Backend is running',\n        version: '1.0.0',\n        timestamp: new Date().toISOString()\n      });\n    }\n\n    // Health check (alternative)\n    if (path === '/health' && method === 'GET') {\n      return jsonResponse({\n        status: 'ok',\n        timestamp: new Date().toISOString(),\n        service: 'CaptureAI Workers Backend',\n        version: '1.0.0'\n      });\n    }\n\n    // License Key Authentication routes\n    if (path === '/api/auth/create-free-key' && method === 'POST') {\n      return this.auth.createFreeKey(request);\n    }\n    if (path === '/api/auth/validate-key' && method === 'POST') {\n      return this.auth.validateKey(request);\n    }\n    if (path === '/api/auth/me' && method === 'GET') {\n      return this.auth.getCurrentUser(request);\n    }\n    if (path === '/api/auth/usage' && method === 'GET') {\n      return this.ai.getUsage(request);\n    }\n\n    // AI routes\n    if (path === '/api/ai/solve' && method === 'POST') {\n      return this.ai.solve(request);\n    }\n    if (path === '/api/ai/complete' && method === 'POST') {\n      return this.ai.complete(request);\n    }\n    if (path === '/api/ai/usage' && method === 'GET') {\n      return this.ai.getUsage(request);\n    }\n    if (path === '/api/ai/models' && method === 'GET') {\n      return this.ai.getModels(request);\n    }\n\n    // Subscription routes\n    if (path === '/api/subscription/create-checkout' && method === 'POST') {\n      return this.subscription.createCheckout(request);\n    }\n    if (path === '/api/subscription/webhook' && method === 'POST') {\n      return this.subscription.handleWebhook(request);\n    }\n    if (path === '/api/subscription/portal' && method === 'GET') {\n      return this.subscription.getPortal(request);\n    }\n    if (path === '/api/subscription/plans' && method === 'GET') {\n      return this.subscription.getPlans(request);\n    }\n\n    // 404 Not Found\n    return jsonResponse(\n      { error: 'Route not found', path },\n      404\n    );\n  }\n}\n", "/**\n * CaptureAI Cloudflare Workers Backend\n * Main entry point for the Worker\n */\n\nimport { Router } from './router';\nimport { handleCORS } from './utils';\nimport { createRequestLogger, logCorsRejection } from './logger';\n\nexport default {\n  async fetch(request, env, ctx) {\n    // Create request logger\n    const logger = createRequestLogger(env, request);\n    const startTime = Date.now();\n\n    // Handle CORS preflight\n    if (request.method === 'OPTIONS') {\n      logger.debug('CORS preflight request');\n      return handleCORS(request);\n    }\n\n    try {\n      logger.info('Request received');\n\n      // Create router instance\n      const router = new Router(env, logger);\n\n      // Route the request\n      const response = await router.route(request);\n\n      // Log response\n      const duration = Date.now() - startTime;\n      logger.info('Request completed', {\n        status: response.status,\n        duration\n      });\n\n      // Add CORS headers to all responses\n      return addCORSHeaders(response, request);\n\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      logger.error('Worker error', error, { duration });\n\n      return new Response(\n        JSON.stringify({\n          error: 'Internal server error'\n        }),\n        {\n          status: 500,\n          headers: {\n            'Content-Type': 'application/json',\n            ...getCORSHeaders(request)\n          }\n        }\n      );\n    }\n  }\n};\n\n/**\n * Add CORS headers to response\n */\nfunction addCORSHeaders(response) {\n  const newResponse = new Response(response.body, response);\n\n  // Add CORS headers\n  Object.entries(getCORSHeaders()).forEach(([key, value]) => {\n    newResponse.headers.set(key, value);\n  });\n\n  return newResponse;\n}\n\n/**\n * Get CORS headers\n * Restricts requests to trusted origins only\n */\nfunction getCORSHeaders(request) {\n  // List of allowed origins\n  const allowedOrigins = [\n    'https://thesuperiorflash.github.io',\n  ];\n\n  // Development/testing origins (only if in dev mode)\n  const isDev = typeof globalThis !== 'undefined' && globalThis.env?.ENVIRONMENT === 'development';\n  if (isDev) {\n    allowedOrigins.push('http://localhost:3000', 'http://localhost:8080', 'http://127.0.0.1:3000');\n  }\n\n  // Get origin from request\n  const origin = request?.headers?.get('Origin') || '';\n\n  // Check if origin is allowed\n  let allowedOrigin = 'null';\n  if (origin) {\n    // Exact match for standard origins\n    if (allowedOrigins.includes(origin)) {\n      allowedOrigin = origin;\n    }\n    // Chrome extension support (all extensions allowed)\n    else if (origin.startsWith('chrome-extension://')) {\n      allowedOrigin = origin;\n    }\n    // Match GitHub Pages subdomain\n    else if (origin.match(/^https:\\/\\/.*\\.github\\.io$/)) {\n      allowedOrigin = origin;\n    }\n  }\n\n  return {\n    'Access-Control-Allow-Origin': allowedOrigin,\n    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    'Access-Control-Max-Age': '86400',\n    'Access-Control-Allow-Credentials': 'true',\n  };\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\SuperiorFlash\\\\IdeaProjects\\\\CaptureAI\\\\backend\\\\src\\\\index.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\SuperiorFlash\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\SuperiorFlash\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\SuperiorFlash\\\\IdeaProjects\\\\CaptureAI\\\\backend\\\\src\\\\index.js\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\SuperiorFlash\\\\IdeaProjects\\\\CaptureAI\\\\backend\\\\.wrangler\\\\tmp\\\\bundle-acU3Du\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\SuperiorFlash\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\SuperiorFlash\\\\IdeaProjects\\\\CaptureAI\\\\backend\\\\.wrangler\\\\tmp\\\\bundle-acU3Du\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\SuperiorFlash\\\\IdeaProjects\\\\CaptureAI\\\\backend\\\\.wrangler\\\\tmp\\\\bundle-acU3Du\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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",
  "names": ["result"]
}
